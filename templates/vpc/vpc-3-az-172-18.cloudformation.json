{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Sample VPC",

  "Parameters" : {

    "KeyName" : {
      "Type" : "AWS::EC2::KeyPair::KeyName",
      "Default" : "testkey",
      "Description" : "EC2 KeyPair to enable SSH access"
    },

    "SSHLocation" : {
      "Description" : "SSH access to the bastion host",
      "Type" : "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default" : "0.0.0.0/0",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "must be a valid CIDR range of the form x.x.x.x/x."
    },

    "WebServerInstanceType" : {
      "Description" : "WebServer Server EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small"
    }

  },

  "Mappings" : {

    "AWSRegionAMI" : {
      "us-east-1"        : { "AMI" : "ami-97785bed" } ,
      "us-west-2"        : { "AMI" : "ami-f2d3638a" } ,
      "us-west-1"        : { "AMI" : "ami-824c4ee2" } ,
      "eu-west-1"        : { "AMI" : "ami-d834aba1" } ,
      "eu-west-2"        : { "AMI" : "ami-403e2524" } ,
      "eu-west-3"        : { "AMI" : "ami-8ee056f3" } ,
      "eu-central-1"     : { "AMI" : "ami-5652ce39" } ,
      "ap-northeast-1"   : { "AMI" : "ami-ceafcba8" } ,
      "ap-northeast-2"   : { "AMI" : "ami-863090e8" } ,
      "ap-northeast-3"   : { "AMI" : "ami-83444afe" } ,
      "ap-southeast-1"   : { "AMI" : "ami-68097514" } ,
      "ap-southeast-2"   : { "AMI" : "ami-942dd1f6" } ,
      "ap-south-1"       : { "AMI" : "ami-531a4c3c" } ,
      "us-east-2"        : { "AMI" : "ami-f63b1193" } ,
      "ca-central-1"     : { "AMI" : "ami-a954d1cd" } ,
      "sa-east-1"        : { "AMI" : "ami-84175ae8" } ,
      "cn-north-1"       : { "AMI" : "ami-cb19c4a6" } ,
      "cn-northwest-1"   : { "AMI" : "ami-3e60745c" }
    },

    "SubnetConfig" : {
      "VPC"   : { "CIDR" : "172.18.0.0/16" },

      "PubA"  : { "CIDR" : "172.18.11.0/24" },
      "PrivA" : { "CIDR" : "172.18.12.0/24" },
      "DataA" : { "CIDR" : "172.18.13.0/24" },

      "PubB"  : { "CIDR" : "172.18.21.0/24" },
      "PrivB" : { "CIDR" : "172.18.22.0/24" },
      "DataB" : { "CIDR" : "172.18.23.0/24" },

      "PubC"  : { "CIDR" : "172.18.31.0/24" },
      "PrivC" : { "CIDR" : "172.18.32.0/24" },
      "DataC" : { "CIDR" : "172.18.33.0/24" }
    }

  },

  "Resources" : {

    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Fn::FindInMap" : [ "SubnetConfig", "VPC", "CIDR" ]},
        "EnableDnsSupport"   : "true",
        "EnableDnsHostnames" : "true",
        "Tags" : [
          { "Key" : "Name"    , "Value" : "VPC-cf" },
          { "Key" : "Network" , "Value" : "Public" }
        ]
      }
    },

    "SubnetPubA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PubA", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Public-A" } ]
      }
    },
    "SubnetPrivA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PrivA", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Private-A" } ]
      }
    },
    "SubnetDataA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "DataA", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Db-A" } ]
      }
    },

    "SubnetPubB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PubB", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Public-B" } ]
      }
    },
    "SubnetPrivB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PrivB", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Private-B" } ]
      }
    },
    "SubnetDataB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "DataB", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Db-B" } ]
      }
    },

    "SubnetPubC" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PubC", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Public-C" } ]
      }
    },
    "SubnetPrivC" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "PrivC", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Private-C" } ]
      }
    },
    "SubnetDataC" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId": { "Ref": "VPC" },
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "CidrBlock": { "Fn::FindInMap": [ "SubnetConfig", "DataC", "CIDR" ]},
        "Tags"     : [ { "Key" : "Name"  ,   "Value" : "Subnet-Db-C" } ]
      }
    },


    "IGW" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackId" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },

    "IGWAttach" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" }, "InternetGatewayId" : { "Ref" : "IGW" }
       }
    },

    "RouteTablePublic" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name", "Value" : "Route-Table-Public" } ]
        ]
      }
    },

    "RouteIGW" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "IGW",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePublic" },
        "DestinationCidrBlock" : "0.0.0.0/0", "GatewayId" : { "Ref" : "IGW" }
      }
    },

    "RouteTableAssociationPubA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : { "RouteTableId" : { "Ref" : "RouteTablePublic" }, "SubnetId" : { "Ref" : "SubnetPubA" } }
    },
    "RouteTableAssociationPubB" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : { "RouteTableId" : { "Ref" : "RouteTablePublic" }, "SubnetId" : { "Ref" : "SubnetPrivA" } }
    },
    "RouteTableAssociationPubC" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : { "RouteTableId" : { "Ref" : "RouteTablePublic" }, "SubnetId" : { "Ref" : "SubnetDataA" } }
    },



    "EIPNatGwA" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : { "Domain" : "vpc" }
    },
    "NatGwA" : {
      "Type" : "AWS::EC2::NatGateway",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : ["EIPNatGwA", "AllocationId"]},
        "SubnetId" : { "Ref" : "SubnetPubA"},
        "Tags" : [ { "Key" : "Name", "Value" : "NatGW-A" } ]
      }
    },
    "RouteTablePrivA" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name", "Value" : "Route-Table-Priv-A" } ]
      }
    },
    "RouteNatGwA" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePrivA" },
        "DestinationCidrBlock" : "0.0.0.0/0", "NatGatewayId" : { "Ref" : "NatGwA" }
      }
    },
    "RouteTableAssociationPrivA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : { "RouteTableId" : { "Ref" : "RouteTablePrivA" }, "SubnetId" : { "Ref" : "SubnetPrivA" } }
    },
    "RouteTableAssociationDataA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : { "RouteTableId" : { "Ref" : "RouteTablePrivA" }, "SubnetId" : { "Ref" : "SubnetDataA" } }
    }



  },

  "Outputs" : {
    "SubnetPubA"  : { "Description" : "PubA" , "Value" : { "Ref" : "SubnetPubA"  } },
    "SubnetPrivA" : { "Description" : "PrivA", "Value" : { "Ref" : "SubnetPrivA" } },
    "SubnetDataA" : { "Description" : "DataA", "Value" : { "Ref" : "SubnetDataA" } },
    "SubnetPubB"  : { "Description" : "PubB" , "Value" : { "Ref" : "SubnetPubB"  } },
    "SubnetPrivB" : { "Description" : "PrivB", "Value" : { "Ref" : "SubnetPrivB" } },
    "SubnetDataB" : { "Description" : "DataB", "Value" : { "Ref" : "SubnetDataB" } },
    "SubnetPubC"  : { "Description" : "PubC" , "Value" : { "Ref" : "SubnetPubC"  } },
    "SubnetPrivC" : { "Description" : "PrivC", "Value" : { "Ref" : "SubnetPrivC" } },
    "SubnetDataC" : { "Description" : "DataC", "Value" : { "Ref" : "SubnetDataC" } },
    "VPC"         : { "Description" : "VPC"  , "Value" : { "Ref" : "VPC"         } }
  }

}


